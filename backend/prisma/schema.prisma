// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  name     String?
  phone    String?
  picture  String?
  googleId String  @unique

  // Role flags - a user can have multiple roles
  isAdmin   Boolean @default(false)
  isTeacher Boolean @default(false)
  isParent  Boolean @default(false)
  isWard    Boolean @default(false)

  // Onboarding status
  onboardingComplete Boolean @default(false)

  // Privacy: what's visible when searched for invite
  showEmailInSearch Boolean @default(true)
  showPhoneInSearch Boolean @default(true)
  showWardsInSearch Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedCoachings      Coaching[]        @relation("CoachingOwner")
  sessions            LoginSession[]
  wards               Ward[]            @relation("UserWards")
  memberships         CoachingMember[]
  receivedInvitations Invitation[]      @relation("UserInvitations")
  sentInvitations     Invitation[]      @relation("SentInvitations")
  notifications       Notification[]    @relation("UserNotifications")
  academicProfile     AcademicProfile?
  uploadedNotes       BatchNote[]       @relation("NoteUploader")
  sentNotices         BatchNotice[]     @relation("NoticeSender")
}

model Ward {
  id       String    @id @default(uuid())
  name     String
  picture  String?
  dob      DateTime?
  school   String?
  class    String?   @map("class")
  parentId String
  parent   User      @relation("UserWards", fields: [parentId], references: [id], onDelete: Cascade)

  enrollments CoachingMember[]
  invitations Invitation[]     @relation("WardInvitations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
}

model LoginSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model Coaching {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String?
  logo        String?
  coverImage  String? // Cover image for profile header
  status      String  @default("active") // active, suspended

  // Extended profile info
  tagline       String? // Short catchy phrase
  aboutUs       String? // Detailed description
  foundedYear   Int?
  websiteUrl    String?
  contactEmail  String?
  contactPhone  String?
  whatsappPhone String?

  // Category & Type
  category String? // COACHING, TUITION, SCHOOL, COLLEGE, ONLINE, etc.
  subjects String[] @default([]) // Subjects taught

  // Social media
  facebookUrl  String?
  instagramUrl String?
  youtubeUrl   String?
  linkedinUrl  String?

  // Verification & Trust
  isVerified         Boolean @default(false)
  verificationDocs   String[] @default([])
  onboardingComplete Boolean @default(false)

  // Storage quota (bytes)
  storageUsed  BigInt @default(0)
  storageLimit BigInt @default(524288000) // 500 MB default

  // Owner relation
  ownerId String
  owner   User   @relation("CoachingOwner", fields: [ownerId], references: [id])

  // Relations
  members       CoachingMember[]
  invitations   Invitation[]
  notifications Notification[]
  address       CoachingAddress?
  branches      CoachingBranch[]
  batches       Batch[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model CoachingAddress {
  id         String   @id @default(uuid())
  coachingId String   @unique
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  // Full address
  addressLine1 String
  addressLine2 String?
  landmark     String?
  city         String
  state        String
  pincode      String
  country      String @default("India")

  // GPS coordinates for exact location
  latitude  Float?
  longitude Float?

  // Operating hours
  openingTime String? // e.g., "09:00"
  closingTime String? // e.g., "18:00"
  workingDays String[] @default([]) // ["MON", "TUE", "WED", "THU", "FRI", "SAT"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CoachingBranch {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  name         String // Branch name/identifier
  addressLine1 String
  addressLine2 String?
  landmark     String?
  city         String
  state        String
  pincode      String
  country      String @default("India")

  // Contact for this branch
  contactPhone String?
  contactEmail String?

  // Operating hours for this branch
  openingTime String?
  closingTime String?
  workingDays String[] @default([])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
}

model CoachingMember {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  role String @default("STUDENT") // ADMIN, TEACHER, STUDENT

  // Link to either a main User (for staff) or a Ward (for students)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  wardId String?
  ward   Ward?   @relation(fields: [wardId], references: [id], onDelete: Cascade)

  status String @default("active") // active, pending, suspended

  // Batch memberships
  batchMembers BatchMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachingId, userId])
  @@unique([coachingId, wardId])
  @@index([coachingId])
  @@index([coachingId, status])
  @@index([coachingId, role])
  @@index([userId])
  @@index([wardId])
}

model Invitation {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  role String // TEACHER, PARENT, STUDENT

  // Target: resolved user/ward
  userId String?
  user   User?   @relation("UserInvitations", fields: [userId], references: [id])
  wardId String?
  ward   Ward?   @relation("WardInvitations", fields: [wardId], references: [id])

  // Unresolved contact (user not yet on platform)
  invitePhone String?
  inviteEmail String?
  inviteName  String?

  status String @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED

  invitedById String
  invitedBy   User   @relation("SentInvitations", fields: [invitedById], references: [id])

  message String?

  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  respondedAt DateTime?

  @@unique([coachingId, userId, role])
  @@unique([coachingId, wardId])
  @@index([coachingId])
  @@index([userId])
  @@index([invitePhone])
  @@index([inviteEmail])
}

model Notification {
  id         String    @id @default(uuid())
  coachingId String?
  coaching   Coaching? @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  userId     String? // For personal notifications (optional future use)
  user       User?     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  type     String // e.g. 'MEMBER_JOINED_ANOTHER_COACHING'
  title    String
  message  String
  read     Boolean @default(false)
  archived Boolean @default(false)
  data     Json? // Metadata: { relatedUserId, relatedMemberId, targetCoachingName }

  createdAt DateTime @default(now())

  @@index([coachingId])
  @@index([userId])
  @@index([coachingId, archived])
  @@index([userId, read])
}

model AcademicProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // School & Board
  schoolName String?
  board      String? // CBSE, ICSE, State board codes

  // Class & Stream
  classId String? // CLASS_1, CLASS_2, ... CLASS_12, DROPPER, etc.
  stream  String? // SCIENCE_PCM, SCIENCE_PCB, COMMERCE, ARTS, etc.

  // Subjects and competitive exams (JSON arrays)
  subjects         String[] @default([])
  competitiveExams String[] @default([])

  // Target year for competitive exams
  targetYear Int?

  // Onboarding status
  status      String    @default("PENDING") // PENDING, COMPLETED, REMIND_LATER
  remindAt    DateTime? // When to show reminder again
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status, remindAt])
}

// ─── Batch Management ────────────────────────────────────────────────

model Batch {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  name        String
  subject     String?
  description String?

  // Schedule
  startTime String?  // e.g. "09:00"
  endTime   String?  // e.g. "10:30"
  days      String[] @default([]) // ["MON", "TUE", "WED"]

  // Capacity
  maxStudents Int @default(0) // 0 = unlimited

  status String @default("active") // active, archived

  // Relations
  members BatchMember[]
  notes   BatchNote[]
  notices BatchNotice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
  @@index([coachingId, status])
}

model BatchMember {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  memberId String
  member   CoachingMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  role String @default("STUDENT") // TEACHER, STUDENT

  createdAt DateTime @default(now())

  @@unique([batchId, memberId])
  @@index([batchId])
  @@index([memberId])
}

model BatchNote {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  title       String
  description String?

  uploadedById String
  uploadedBy   User   @relation("NoteUploader", fields: [uploadedById], references: [id])

  // Attachments (files + links)
  attachments NoteAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId])
  @@index([batchId, createdAt])
  @@index([uploadedById])
}

model NoteAttachment {
  id     String    @id @default(uuid())
  noteId String
  note   BatchNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  url         String
  fileName    String?
  description String? // optional description for this specific attachment
  fileType    String  @default("pdf") // pdf, image, doc, link
  fileSize    Int     @default(0) // bytes
  mimeType    String?

  createdAt DateTime @default(now())

  @@index([noteId])
}

model BatchNotice {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  title    String
  message  String
  priority String @default("normal") // low, normal, high, urgent
  type     String @default("general") // general, timetable_update, event, exam, holiday, assignment

  // Structured data for specific notice types
  date      DateTime? // date for events/exams/holidays
  startTime String?   // e.g. "09:00"
  endTime   String?   // e.g. "10:30"
  day       String?   // e.g. "MON"
  location  String?   // e.g. "Room 201"

  sentById String
  sentBy   User   @relation("NoticeSender", fields: [sentById], references: [id])

  createdAt DateTime @default(now())

  @@index([batchId])
  @@index([batchId, createdAt])
  @@index([sentById])
}
