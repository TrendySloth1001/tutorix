// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  name     String?
  phone    String?
  picture  String?
  googleId String  @unique

  // Role flags - a user can have multiple roles
  isAdmin   Boolean @default(false)
  isTeacher Boolean @default(false)
  isParent  Boolean @default(false)
  isWard    Boolean @default(false)

  // Onboarding status
  onboardingComplete Boolean @default(false)

  // Privacy: what's visible when searched for invite
  showEmailInSearch Boolean @default(true)
  showPhoneInSearch Boolean @default(true)
  showWardsInSearch Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownedCoachings      Coaching[]        @relation("CoachingOwner")
  sessions            LoginSession[]
  wards               Ward[]            @relation("UserWards")
  memberships         CoachingMember[]
  receivedInvitations Invitation[]      @relation("UserInvitations")
  sentInvitations     Invitation[]      @relation("SentInvitations")
  notifications       Notification[]    @relation("UserNotifications")
  academicProfile     AcademicProfile?
  uploadedNotes       BatchNote[]       @relation("NoteUploader")
  sentNotices         BatchNotice[]     @relation("NoticeSender")
  savedCoachings      SavedCoaching[]   @relation("UserSavedCoachings")
  createdAssessments  Assessment[]      @relation("AssessmentCreator")
  assessmentAttempts  AssessmentAttempt[] @relation("AssessmentAttempts")
  createdAssignments  Assignment[]      @relation("AssignmentCreator")
  assignmentSubmissions AssignmentSubmission[] @relation("AssignmentSubmissions")
  markedFeeRecords    FeeRecord[]        @relation("FeeMarkedBy")
  recordedFeePayments FeePayment[]       @relation("FeePaymentRecorder")
  processedFeeRefunds FeeRefund[]        @relation("FeeRefundProcessor")
  razorpayOrders      RazorpayOrder[]    @relation("RazorpayOrderUser")
  feeAuditActions     FeeAuditLog[]      @relation("FeeAuditActor")
}

model Ward {
  id       String    @id @default(uuid())
  name     String
  picture  String?
  dob      DateTime?
  school   String?
  class    String?   @map("class")
  parentId String
  parent   User      @relation("UserWards", fields: [parentId], references: [id], onDelete: Cascade)

  enrollments CoachingMember[]
  invitations Invitation[]     @relation("WardInvitations")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
}

model LoginSession {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip        String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
}

model Coaching {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique
  description String?
  logo        String?
  coverImage  String? // Cover image for profile header
  status      String  @default("active") // active, suspended

  // Extended profile info
  tagline       String? // Short catchy phrase
  aboutUs       String? // Detailed description
  foundedYear   Int?
  websiteUrl    String?
  contactEmail  String?
  contactPhone  String?
  whatsappPhone String?

  // Category & Type
  category String? // COACHING, TUITION, SCHOOL, COLLEGE, ONLINE, etc.
  subjects String[] @default([]) // Subjects taught

  // Social media
  facebookUrl  String?
  instagramUrl String?
  youtubeUrl   String?
  linkedinUrl  String?

  // Verification & Trust
  isVerified         Boolean @default(false)
  verificationDocs   String[] @default([])
  onboardingComplete Boolean @default(false)

  // Storage quota (bytes)
  storageUsed  BigInt @default(0)
  storageLimit BigInt @default(524288000) // 500 MB default

  // Owner relation
  ownerId String
  owner   User   @relation("CoachingOwner", fields: [ownerId], references: [id])

  // Relations
  members       CoachingMember[]
  invitations   Invitation[]
  notifications Notification[]
  address       CoachingAddress?
  branches      CoachingBranch[]
  batches       Batch[]
  savedByUsers  SavedCoaching[]   @relation("SavedByUsers")
  assessments   Assessment[]
  assignments   Assignment[]
  feeStructures FeeStructure[]
  feeAssignments FeeAssignment[]
  feeRecords    FeeRecord[]
  feePayments   FeePayment[]
  feeRefunds    FeeRefund[]
  razorpayOrders RazorpayOrder[]
  razorpayWebhookLogs RazorpayWebhookLog[]
  razorpayRefunds RazorpayRefund[]
  receiptSequences ReceiptSequence[]
  feeAuditLogs FeeAuditLog[]

  // Tax & Financial
  gstNumber     String?   // GSTIN (15-char) for tax invoices
  panNumber     String?   // PAN for TDS/compliance

  // Razorpay Route — linked account for direct settlement
  razorpayAccountId String?  // Razorpay linked account id (acc_xxxxx)
  razorpayActivated Boolean @default(false)  // Whether Razorpay Route is active
  platformFeePercent Float  @default(1.0)    // Tutorix commission (default 1%)

  // Bank details (for Razorpay linked account creation)
  bankAccountName   String?
  bankAccountNumber String?
  bankIfscCode      String?
  bankName          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
}

model CoachingAddress {
  id         String   @id @default(uuid())
  coachingId String   @unique
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  // Full address
  addressLine1 String
  addressLine2 String?
  landmark     String?
  city         String
  state        String
  pincode      String
  country      String @default("India")

  // GPS coordinates for exact location
  latitude  Float?
  longitude Float?

  // Operating hours
  openingTime String? // e.g., "09:00"
  closingTime String? // e.g., "18:00"
  workingDays String[] @default([]) // ["MON", "TUE", "WED", "THU", "FRI", "SAT"]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Geo index for findNearby bounding-box queries
  @@index([latitude, longitude])
}

model CoachingBranch {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  name         String // Branch name/identifier
  addressLine1 String
  addressLine2 String?
  landmark     String?
  city         String
  state        String
  pincode      String
  country      String @default("India")

  // Contact for this branch
  contactPhone String?
  contactEmail String?

  // Operating hours for this branch
  openingTime String?
  closingTime String?
  workingDays String[] @default([])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
}

model CoachingMember {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  role String @default("STUDENT") // ADMIN, TEACHER, STUDENT

  // Link to either a main User (for staff) or a Ward (for students)
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  wardId String?
  ward   Ward?   @relation(fields: [wardId], references: [id], onDelete: Cascade)

  status String @default("active") // active, pending, suspended

  // Batch memberships
  batchMembers BatchMember[]

  // Fee assignments & records
  feeAssignments FeeAssignment[]
  feeRecords     FeeRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachingId, userId])
  @@unique([coachingId, wardId])
  @@index([coachingId])
  @@index([coachingId, status])
  @@index([coachingId, role])
  @@index([userId])
  @@index([wardId])
}

model Invitation {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  role String // TEACHER, PARENT, STUDENT

  // Target: resolved user/ward
  userId String?
  user   User?   @relation("UserInvitations", fields: [userId], references: [id])
  wardId String?
  ward   Ward?   @relation("WardInvitations", fields: [wardId], references: [id])

  // Unresolved contact (user not yet on platform)
  invitePhone String?
  inviteEmail String?
  inviteName  String?

  status String @default("PENDING") // PENDING, ACCEPTED, DECLINED, EXPIRED

  invitedById String
  invitedBy   User   @relation("SentInvitations", fields: [invitedById], references: [id])

  message String?

  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  respondedAt DateTime?

  @@unique([coachingId, userId, role])
  @@unique([coachingId, wardId])
  @@index([coachingId])
  @@index([userId])
  @@index([invitePhone])
  @@index([inviteEmail])
  @@index([status])
  @@index([status, inviteEmail])
  @@index([status, invitePhone])
}

model Notification {
  id         String    @id @default(uuid())
  coachingId String?
  coaching   Coaching? @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  userId     String? // For personal notifications (optional future use)
  user       User?     @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  type     String // e.g. 'MEMBER_JOINED_ANOTHER_COACHING'
  title    String
  message  String
  read     Boolean @default(false)
  archived Boolean @default(false)
  data     Json? // Metadata: { relatedUserId, relatedMemberId, targetCoachingName }

  createdAt DateTime @default(now())

  @@index([coachingId])
  @@index([userId])
  @@index([coachingId, archived])
  @@index([userId, read])
}

model AcademicProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // School & Board
  schoolName String?
  board      String? // CBSE, ICSE, State board codes

  // Class & Stream
  classId String? // CLASS_1, CLASS_2, ... CLASS_12, DROPPER, etc.
  stream  String? // SCIENCE_PCM, SCIENCE_PCB, COMMERCE, ARTS, etc.

  // Subjects and competitive exams (JSON arrays)
  subjects         String[] @default([])
  competitiveExams String[] @default([])

  // Target year for competitive exams
  targetYear Int?

  // Onboarding status
  status      String    @default("PENDING") // PENDING, COMPLETED, REMIND_LATER
  remindAt    DateTime? // When to show reminder again
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([status, remindAt])
}

// ─── Batch Management ────────────────────────────────────────────────

model Batch {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  name        String
  subject     String?
  description String?

  // Schedule
  startTime String?  // e.g. "09:00"
  endTime   String?  // e.g. "10:30"
  days      String[] @default([]) // ["MON", "TUE", "WED"]

  // Capacity
  maxStudents Int @default(0) // 0 = unlimited

  status String @default("active") // active, archived

  // Relations
  members BatchMember[]
  notes   BatchNote[]
  notices BatchNotice[]
  assessments Assessment[]
  assignments Assignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
  @@index([coachingId, status])
}

model BatchMember {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  memberId String
  member   CoachingMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  role String @default("STUDENT") // TEACHER, STUDENT

  createdAt DateTime @default(now())

  @@unique([batchId, memberId])
  @@index([batchId])
  @@index([memberId])
}

model BatchNote {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  title       String
  description String?

  uploadedById String
  uploadedBy   User   @relation("NoteUploader", fields: [uploadedById], references: [id])

  // Attachments (files + links)
  attachments NoteAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId])
  @@index([batchId, createdAt])
  @@index([uploadedById])
}

model NoteAttachment {
  id     String    @id @default(uuid())
  noteId String
  note   BatchNote @relation(fields: [noteId], references: [id], onDelete: Cascade)

  url         String
  fileName    String?
  description String? // optional description for this specific attachment
  fileType    String  @default("pdf") // pdf, image, doc, link
  fileSize    Int     @default(0) // bytes
  mimeType    String?

  createdAt DateTime @default(now())

  @@index([noteId])
}

model BatchNotice {
  id      String @id @default(uuid())
  batchId String
  batch   Batch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  title    String
  message  String
  priority String @default("normal") // low, normal, high, urgent
  type     String @default("general") // general, timetable_update, event, exam, holiday, assignment

  // Structured data for specific notice types
  date      DateTime? // date for events/exams/holidays
  startTime String?   // e.g. "09:00"
  endTime   String?   // e.g. "10:30"
  day       String?   // e.g. "MON"
  location  String?   // e.g. "Room 201"

  sentById String
  sentBy   User   @relation("NoticeSender", fields: [sentById], references: [id])

  createdAt DateTime @default(now())

  @@index([batchId])
  @@index([batchId, createdAt])
  @@index([sentById])
}

// ─── Saved / Bookmarked Coachings ─────────────────────────────────────

model SavedCoaching {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation("UserSavedCoachings", fields: [userId], references: [id], onDelete: Cascade)
  coachingId String
  coaching   Coaching @relation("SavedByUsers", fields: [coachingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, coachingId])
  @@index([userId])
  @@index([coachingId])
}

// ─── Assessment System ────────────────────────────────────────────────

model Assessment {
  id         String   @id @default(uuid())
  batchId    String
  batch      Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  title       String
  description String?
  type        String  @default("QUIZ") // QUIZ, TEST, PRACTICE

  // Timing
  durationMinutes Int?     // null = unlimited
  startTime       DateTime? // scheduled start (null = available immediately)
  endTime         DateTime? // deadline (null = no deadline)

  // Settings
  totalMarks      Int      @default(0) // auto-calculated from questions
  passingMarks    Int?
  shuffleQuestions Boolean @default(false)
  shuffleOptions   Boolean @default(false)
  showResultAfter  String  @default("SUBMIT") // SUBMIT, MANUAL (teacher releases)
  maxAttempts      Int     @default(1)
  negativeMarking  Float   @default(0) // 0 = no negative, 0.25 = quarter, etc.

  status String @default("DRAFT") // DRAFT, PUBLISHED, CLOSED

  createdById String
  createdBy   User   @relation("AssessmentCreator", fields: [createdById], references: [id])

  // Relations
  questions AssessmentQuestion[]
  attempts  AssessmentAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId])
  @@index([coachingId])
  @@index([batchId, status])
  @@index([batchId, status, createdAt])
  @@index([createdById])
}

model AssessmentQuestion {
  id           String     @id @default(uuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  type     String // MCQ, MSQ, NAT (Numerical Answer Type)
  question String // question text
  imageUrl String? // optional question image

  // Options stored as JSON array: [{ id, text, imageUrl? }]
  // For NAT type this is null
  options Json?

  // Correct answer:
  // MCQ → single option id string e.g. "opt_1"
  // MSQ → JSON array of option ids e.g. ["opt_1","opt_3"]
  // NAT → JSON { value: number, tolerance?: number }
  correctAnswer Json

  marks         Int @default(1)
  orderIndex    Int @default(0) // display order

  // Optional explanation shown after submission
  explanation String?

  // Relations
  answers AssessmentAnswer[]

  createdAt DateTime @default(now())

  @@index([assessmentId])
  @@index([assessmentId, orderIndex])
}

model AssessmentAttempt {
  id           String     @id @default(uuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  userId       String
  user         User       @relation("AssessmentAttempts", fields: [userId], references: [id], onDelete: Cascade)

  startedAt   DateTime  @default(now())
  submittedAt DateTime?

  // Calculated after submit
  totalScore    Float?
  maxScore      Float?
  percentage    Float?
  correctCount  Int?
  wrongCount    Int?
  skippedCount  Int?

  status String @default("IN_PROGRESS") // IN_PROGRESS, SUBMITTED, TIMED_OUT

  // Relations
  answers AssessmentAnswer[]

  createdAt DateTime @default(now())

  @@unique([assessmentId, userId, startedAt]) // allow multiple attempts
  @@index([assessmentId])
  @@index([userId])
  @@index([assessmentId, userId])
  @@index([assessmentId, status])
}

model AssessmentAnswer {
  id        String            @id @default(uuid())
  attemptId String
  attempt   AssessmentAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  questionId String
  question   AssessmentQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  // Student's answer:
  // MCQ → option id string
  // MSQ → JSON array of option ids
  // NAT → JSON { value: number }
  answer Json?

  isCorrect Boolean?
  marksAwarded Float @default(0)

  answeredAt DateTime @default(now())

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
}

// ─── Assignment System ────────────────────────────────────────────────

model Assignment {
  id         String   @id @default(uuid())
  batchId    String
  batch      Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  title       String
  description String?

  dueDate            DateTime?
  allowLateSubmission Boolean @default(false)

  // Attachments from teacher (instructions/reference)
  totalMarks Int?

  status String @default("ACTIVE") // ACTIVE, CLOSED

  createdById String
  createdBy   User   @relation("AssignmentCreator", fields: [createdById], references: [id])

  // Relations
  attachments    AssignmentAttachment[]
  submissions    AssignmentSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([batchId])
  @@index([coachingId])
  @@index([batchId, status])
  @@index([batchId, status, createdAt])
  @@index([createdById])
}

model AssignmentAttachment {
  id           String     @id @default(uuid())
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  url      String
  fileName String?
  fileType String  @default("pdf") // pdf, image
  fileSize Int     @default(0)
  mimeType String?

  createdAt DateTime @default(now())

  @@index([assignmentId])
}

model AssignmentSubmission {
  id           String     @id @default(uuid())
  assignmentId String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  userId       String
  user         User       @relation("AssignmentSubmissions", fields: [userId], references: [id], onDelete: Cascade)

  // Teacher grading
  marks    Float?
  feedback String?
  gradedAt DateTime?

  isLate Boolean @default(false)

  status String @default("SUBMITTED") // SUBMITTED, GRADED, RETURNED

  // Relations
  files AssignmentSubmissionFile[]

  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([assignmentId, userId]) // one submission per student
  @@index([assignmentId])
  @@index([userId])
  @@index([assignmentId, status])
}

model AssignmentSubmissionFile {
  id           String               @id @default(uuid())
  submissionId String
  submission   AssignmentSubmission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  url      String
  fileName String?
  fileType String  @default("image") // image, pdf
  fileSize Int     @default(0)
  mimeType String?

  createdAt DateTime @default(now())

  @@index([submissionId])
}

// ═══════════════════════════════════════════════════════════════════════
// Fee Management System
// ═══════════════════════════════════════════════════════════════════════

/// A reusable fee template defined at coaching level.
/// e.g. "Monthly Tuition", "Annual Registration", "Exam Fee"
model FeeStructure {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  name        String   // "Monthly Tuition", "Registration Fee"
  description String?
  amount      Float    // base amount in INR
  currency    String   @default("INR")

  // Billing cycle: ONCE, MONTHLY, QUARTERLY, HALF_YEARLY, YEARLY, CUSTOM, INSTALLMENT
  cycle       String   @default("MONTHLY")

  // fine per day after due date
  lateFinePerDay Float @default(0)

  // ── Tax Configuration ───────────────────────────────────────────
  // GST applicability: NONE, GST_INCLUSIVE, GST_EXCLUSIVE
  taxType      String  @default("NONE")
  // GST rate %: 0, 5, 12, 18, 28 (standard Indian rates)
  gstRate      Float   @default(0)
  // SAC code (Service Accounting Code) for education services
  sacCode      String?  // e.g. "999293" for coaching/tuition
  // HSN code (if selling materials/goods)
  hsnCode      String?
  // Whether IGST (inter-state) or CGST+SGST (intra-state) — auto-derived from coaching state vs student state
  // INTRA_STATE → CGST + SGST (50-50 split), INTER_STATE → IGST
  gstSupplyType String @default("INTRA_STATE")
  // Additional cess % (education cess, etc.)
  cessRate     Float   @default(0)

  // ── Fee Breakdown / Line Items (admin-defined) ──────────────────
  // JSON array: [{ label: "Tuition Fee", amount: 400 }, { label: "Lab Fee", amount: 80 }]
  // If provided, these line items sum to `amount`. Empty = single base amount.
  lineItems    Json?

  // Optional installment plan (JSON): [{label, dueDate, amount}]
  // Used when cycle = INSTALLMENT
  installmentPlan Json?

  // Optional discount config (JSON): [{ type: "SIBLING"|"EARLY_BIRD", value: float, unit: "PERCENT"|"FLAT" }]
  discounts Json?

  isActive Boolean @default(true)

  // ── Single-structure-per-coaching enforcement ───────────────────
  // Only ONE FeeStructure per coaching may have isCurrent=true at a time.
  // When a new structure is created/promoted it sets old one to false.
  isCurrent  Boolean   @default(false) // the active structure for new assignments
  replacedAt DateTime?                 // when this was superseded

  // ── Admin-controlled Installments ──────────────────────────────
  // Whether parents/students are allowed to pay in installments.
  allowInstallments  Boolean @default(false)
  // Max number of installments admin permits (0 = unlimited if allowed)
  installmentCount   Int     @default(0)
  // Admin-defined fixed installment buckets (JSON):
  // [{ label: "Term 1", amount: 5000 }, { label: "Term 2", amount: 5000 }]
  // If set, the payer MUST choose one of these amounts; free-form amount is blocked.
  installmentAmounts Json?

  // Relations
  assignments FeeAssignment[]
  auditLogs   FeeAuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
  @@index([coachingId, isActive])
}

/// Maps a FeeStructure to a specific member (student). Carries the
/// negotiated amount (may differ from structure base), the start date,
/// and generates FeeRecord rows automatically each cycle.
model FeeAssignment {
  id              String       @id @default(uuid())
  coachingId      String
  coaching        Coaching     @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  feeStructureId  String
  feeStructure    FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  memberId        String
  member          CoachingMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  /// Overrides structure base amount (e.g. after discount negotiation)
  customAmount    Float?
  discountAmount  Float  @default(0)
  discountReason  String?

  startDate DateTime @default(now())
  endDate   DateTime? // null = ongoing

  isActive Boolean @default(true)

  // Pause support (fee freeze)
  isPaused   Boolean   @default(false)
  pausedAt   DateTime?
  pauseNote  String?

  // Scholarship tagging
  scholarshipTag    String?  // e.g. "Merit", "Need-based"
  scholarshipAmount Float?   // additional discount amount

  // Records generated for this assignment
  records FeeRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([coachingId, memberId]) // one active assignment per student per coaching
  @@index([memberId])
  @@index([feeStructureId])
}

/// A single payable instance (e.g. "April 2025 Tuition" for a student).
/// One record per cycle per assignment.
model FeeRecord {
  id             String        @id @default(uuid())
  coachingId     String
  coaching       Coaching      @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  assignmentId   String
  assignment     FeeAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  memberId       String
  member         CoachingMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  title       String           // e.g. "April 2025 - Monthly Tuition"
  amount      Float            // final payable = base - discount + fine
  baseAmount  Float            // snapshot of amount at time of creation
  discountAmount Float         @default(0)
  fineAmount  Float            @default(0)
  finalAmount Float            // computed: baseAmount - discountAmount + fineAmount + taxAmount

  // ── Tax Breakdown (snapshot from FeeStructure at creation) ──────
  taxType     String  @default("NONE")     // NONE, GST_INCLUSIVE, GST_EXCLUSIVE
  taxAmount   Float   @default(0)          // total tax
  cgstAmount  Float   @default(0)          // Central GST
  sgstAmount  Float   @default(0)          // State GST
  igstAmount  Float   @default(0)          // Integrated GST (inter-state)
  cessAmount  Float   @default(0)          // Education cess
  gstRate     Float   @default(0)          // snapshot of rate used
  sacCode     String?                      // snapshot
  hsnCode     String?                      // snapshot

  // ── Line Items Breakdown (snapshot) ─────────────────────────────
  // JSON: [{ label, amount }] — frozen at record creation time
  lineItems   Json?

  dueDate  DateTime
  paidAt   DateTime?

  /// PENDING, PAID, PARTIALLY_PAID, WAIVED, OVERDUE, CANCELLED
  status String @default("PENDING")

  // Payment mode: CASH, ONLINE, UPI, BANK_TRANSFER, CHEQUE, OTHER
  paymentMode String?
  transactionRef String? // UPI ref, cheque no., etc.
  receiptNo String?    // human-readable receipt

  paidAmount Float @default(0) // for partial payments

  notes String? // admin notes / remarks

  // Reminder tracking
  reminderSentAt DateTime?
  reminderCount  Int       @default(0)

  // Who marked it paid
  markedById String?
  markedBy   User?   @relation("FeeMarkedBy", fields: [markedById], references: [id])

  // Payments (for partial payment breakdown)
  payments FeePayment[]
  refunds  FeeRefund[]
  razorpayOrders RazorpayOrder[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
  @@index([memberId])
  @@index([assignmentId])
  @@index([coachingId, status])
  @@index([coachingId, dueDate])
  @@index([memberId, status])
  @@index([memberId, dueDate])
}

/// Each actual payment transaction against a FeeRecord.
/// Enables partial / split payments and full audit trail.
model FeePayment {
  id          String    @id @default(uuid())
  coachingId  String
  coaching    Coaching  @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  recordId    String
  record      FeeRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  amount      Float
  mode        String   // CASH, ONLINE, UPI, BANK_TRANSFER, CHEQUE, OTHER, RAZORPAY
  transactionRef String?
  receiptNo   String?
  notes       String?

  // Razorpay linkage (populated for online payments)
  razorpayOrderId   String?
  razorpayPaymentId String?

  // Razorpay Route transfer tracking
  razorpayTransferId String?  // transfer_xxxxx — funds moved to coaching's linked account

  paidAt     DateTime @default(now())
  recordedById String?
  recordedBy  User?    @relation("FeePaymentRecorder", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())

  @@index([recordId])
  @@index([coachingId])
  @@index([coachingId, paidAt])
}

/// Refund against a FeeRecord — creates a negative entry for clean ledger accounting.
model FeeRefund {
  id          String    @id @default(uuid())
  coachingId  String
  coaching    Coaching  @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  recordId    String
  record      FeeRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  amount      Float
  reason      String?
  mode        String    @default("CASH") // CASH, BANK_TRANSFER, ONLINE, RAZORPAY
  refundedAt  DateTime  @default(now())
  processedById String?
  processedBy User?     @relation("FeeRefundProcessor", fields: [processedById], references: [id])

  // Razorpay refund linkage
  razorpayRefund RazorpayRefund?

  createdAt DateTime @default(now())

  @@index([recordId])
  @@index([coachingId])
}

// ═══════════════════════════════════════════════════════════════════════
// Razorpay Payment Gateway
// ═══════════════════════════════════════════════════════════════════════

/// Tracks Razorpay orders initiated by students/parents for fee payment.
model RazorpayOrder {
  id            String   @id @default(uuid())
  coachingId    String
  coaching      Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)
  recordId      String
  record        FeeRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  userId        String
  user          User     @relation("RazorpayOrderUser", fields: [userId], references: [id])

  /// Razorpay order_id (e.g. "order_xxxxxxxxxxxxxx")
  /// Not unique — multi-pay creates one row per FeeRecord all sharing the same razorpayOrderId
  razorpayOrderId String

  /// Amount in paise (₹100 → 10000)
  amountPaise   Int
  currency      String  @default("INR")

  /// CREATED | PAID | FAILED | EXPIRED
  status        String  @default("CREATED")

  /// Populated after successful payment
  razorpayPaymentId  String?
  razorpaySignature  String?

  /// Webhook tracking
  webhookReceived    Boolean @default(false)
  webhookReceivedAt  DateTime?

  /// Metadata
  receipt       String?  // e.g. "rcpt_<recordId>_<timestamp>"
  notes         Json?    // Razorpay notes dict

  /// Whether this order was used to record a FeePayment
  paymentRecorded Boolean @default(false)

  /// Failure tracking (user cancellation, SDK errors, etc.)
  failureReason     String?
  failedAt          DateTime?

  /// Razorpay Route transfer — funds to coaching's linked account
  transferId        String?  // Razorpay transfer_id
  transferStatus    String?  // created, processed, settled, failed
  platformFeePaise  Int?     // Tutorix commission in paise

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
  @@index([recordId])
  @@index([userId])
  @@index([status])
  @@index([razorpayOrderId])
}

/// Logs every Razorpay webhook event for audit + replay.
model RazorpayWebhookLog {
  id          String   @id @default(uuid())
  coachingId  String?
  coaching    Coaching? @relation(fields: [coachingId], references: [id])

  event       String   // payment.captured, payment.failed, refund.created, etc.
  orderId     String?  // Razorpay order_id
  paymentId   String?  // Razorpay payment_id
  refundId    String?  // Razorpay refund_id

  payload     Json     // Full webhook payload
  signature   String   // X-Razorpay-Signature header

  verified    Boolean  @default(false)
  processed   Boolean  @default(false)
  error       String?  // Error message if processing failed

  createdAt   DateTime @default(now())

  @@index([event])
  @@index([orderId])
  @@index([paymentId])
  @@index([createdAt])
}

/// Tracks Razorpay refunds initiated by admin.
model RazorpayRefund {
  id              String    @id @default(uuid())
  coachingId      String
  coaching        Coaching  @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  /// Link to our FeeRefund
  feeRefundId     String    @unique
  feeRefund       FeeRefund @relation(fields: [feeRefundId], references: [id], onDelete: Cascade)

  /// Razorpay IDs
  razorpayRefundId  String?  // populated after Razorpay confirms
  razorpayPaymentId String   // the original payment to refund

  amountPaise     Int
  /// INITIATED | PROCESSED | FAILED
  status          String  @default("INITIATED")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachingId])
  @@index([razorpayPaymentId])
  @@index([status])
}

/// Sequential receipt counter per coaching for generating
/// professional receipt numbers like "TXR/2025-26/0001"
model ReceiptSequence {
  id          String   @id @default(uuid())
  coachingId  String
  coaching    Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  /// Financial year prefix: "2025-26"
  financialYear String

  /// Last used number in this FY (auto-incremented)
  lastNumber    Int    @default(0)

  updatedAt DateTime @updatedAt

  @@unique([coachingId, financialYear])
}

// ═══════════════════════════════════════════════════════════════════════
// Fee Audit Trail
// ═══════════════════════════════════════════════════════════════════════

/// Immutable audit trail for all fee-related events.
/// Every important change (structure create/replace, payment, waive, refund,
/// installment setting change, assignment add/remove) is recorded here.
model FeeAuditLog {
  id         String   @id @default(uuid())
  coachingId String
  coaching   Coaching @relation(fields: [coachingId], references: [id], onDelete: Cascade)

  // What entity was affected
  entityType       String   // STRUCTURE | ASSIGNMENT | RECORD | PAYMENT | REFUND
  entityId         String   // UUID of the affected entity

  // Optional FK to the FeeStructure that this log is associated with
  feeStructureId   String?
  feeStructure     FeeStructure? @relation(fields: [feeStructureId], references: [id], onDelete: SetNull)

  // What happened
  // e.g. STRUCTURE_CREATED, STRUCTURE_REPLACED, STRUCTURE_UPDATED,
  //      ASSIGNMENT_CREATED, ASSIGNMENT_REMOVED, ASSIGNMENT_PAUSED, ASSIGNMENT_UNPAUSED,
  //      PAYMENT_RECORDED, FEE_WAIVED, REFUND_ISSUED,
  //      INSTALLMENT_SETTINGS_CHANGED
  event       String

  // Who triggered the change
  // actorType: ADMIN | SYSTEM
  actorType   String   @default("ADMIN")
  actorId     String?  // userId of the admin; null for SYSTEM events
  actor       User?    @relation("FeeAuditActor", fields: [actorId], references: [id])

  // Snapshots for diff view
  before      Json?    // state before the change
  after       Json?    // state after the change

  // Extra context (membersAffected count, replacedStructureId, etc.)
  meta        Json?

  // Human-readable note (e.g. admin's reason)
  note        String?

  createdAt   DateTime @default(now())

  @@index([coachingId])
  @@index([coachingId, entityType])
  @@index([coachingId, createdAt])
  @@index([entityId])
}

// ═══════════════════════════════════════════════════════════════════════
// Admin Logging System
// ═══════════════════════════════════════════════════════════════════════

model Log {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Log type: API_REQUEST, API_ERROR, FRONTEND_ERROR, SYSTEM
  type String

  // Log level: INFO, WARN, ERROR, FATAL
  level String @default("INFO")

  // User context (optional)
  userId     String?
  userEmail  String?
  userName   String?
  userRoles  String[] // ["isAdmin", "isTeacher"] etc

  // Request context (for API logs)
  method      String?
  path        String?
  statusCode  Int?
  duration    Float? // milliseconds
  ip          String?
  userAgent   String?

  // Error details
  message    String?
  error      String? // error message
  stackTrace String? // full stack trace

  // Additional metadata (JSON)
  metadata Json?

  @@index([type])
  @@index([level])
  @@index([userId])
  @@index([createdAt])
  @@index([type, createdAt])
  @@index([level, createdAt])
}
